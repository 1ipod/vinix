# bootstrap.yml: Bootstrap file of the project.
# Code is governed by the GPL-2.0 license.
# Copyright (C) 2021-2022 The Vinix authors.

declare_options:
  - name: prod
    default: 'false' # prod

sources:
  - name: tar
    subdir: '3rdparty'
    git: 'https://git.savannah.gnu.org/git/tar.git'
    tag: 'release_1_34'
    version: '1.34'
    sources_required: ['gnulib']
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
    regenerate:
      - args: ['rm', '-rf', 'gnulib']
      - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
      - args: ['./bootstrap']

  - name: xorg-font-util
    subdir: '3rdparty'
    git: 'https://gitlab.freedesktop.org/xorg/font/util.git'
    tag: 'font-util-1.3.2'
    version: '1.3.2'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
      - host-xorg-macros
    regenerate:
      - args: ['./autogen.sh']
        environ:
          NOCONFIGURE: 'yes'

  - name: libxtrans
    subdir: '3rdparty'
    git: 'https://gitlab.freedesktop.org/xorg/lib/libxtrans.git'
    tag: 'xtrans-1.4.0'
    version: '1.4.0'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
      - host-xorg-macros
    regenerate:
      - args: ['./autogen.sh']
        environ:
          NOCONFIGURE: 'yes'

  - name: gnulib
    subdir: '3rdparty'
    git: 'https://git.savannah.gnu.org/git/gnulib.git'
    branch: 'master'
    rolling_version: true
    version: '0.0pl@ROLLING_ID@'

  - name: glib
    subdir: '3rdparty'
    git: 'https://gitlab.gnome.org/GNOME/glib.git'
    tag: '2.72.1'
    version: '2.72.1'

  - name: pkg-config
    subdir: '3rdparty'
    git: 'https://gitlab.freedesktop.org/pkg-config/pkg-config.git'
    tag: 'pkg-config-0.29.2'
    version: '0.29.2'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
    regenerate:
      - args: ['./autogen.sh']
        environ:
          NOCONFIGURE: 'yes'

  - name: python
    subdir: '3rdparty'
    git: 'https://github.com/python/cpython.git'
    tag: 'v3.8.13'
    version: '3.8.13'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
    regenerate:
      - args: ['autoreconf', '-f', '-i']
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
          '@THIS_SOURCE_DIR@/']

  - name: tzdata
    subdir: '3rdparty'
    sources_required: ['tzcode']
    url: 'https://data.iana.org/time-zones/releases/tzdata2022a.tar.gz'
    format: 'tar.gz'
    version: '2022a'
    regenerate:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/../tzcode/.', '@THIS_SOURCE_DIR@/']

  - name: tzcode
    subdir: '3rdparty'
    url: 'https://data.iana.org/time-zones/releases/tzcode2022a.tar.gz'
    format: 'tar.gz'
    version: '2022a'

  - name: binutils
    subdir: '3rdparty'
    git: 'https://sourceware.org/git/binutils-gdb.git'
    tag: 'binutils-2_38'
    version: '2.38'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
    regenerate:
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
          '@THIS_SOURCE_DIR@/']

  - name: gcc
    subdir: '3rdparty'
    git: 'https://gcc.gnu.org/git/gcc.git'
    tag: 'releases/gcc-12.1.0'
    version: '12.1.0'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
    regenerate:
      - args: ['./contrib/download_prerequisites']
        workdir: '@THIS_SOURCE_DIR@'
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
          '@THIS_SOURCE_DIR@/']
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
          '@THIS_SOURCE_DIR@/gmp-6.2.1/configfsf.sub']
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
          '@THIS_SOURCE_DIR@/isl-0.24/config.sub']
      - args: ['cp', '-f',
          '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
          '@THIS_SOURCE_DIR@/mpc-1.2.1/build-aux/config.sub']
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
          '@THIS_SOURCE_DIR@/mpfr-4.1.0/config.sub']
      - args: ['autoconf']
        workdir: '@THIS_SOURCE_DIR@/gcc'
      - args: ['autoconf']
        workdir: '@THIS_SOURCE_DIR@/libstdc++-v3'

  - name: llvm
    subdir: '3rdparty'
    git: 'https://github.com/llvm/llvm-project.git'
    tag: 'llvmorg-14.0.3'
    version: '14.0.3'

  - name: mlibc
    subdir: '3rdparty'
    git: 'https://github.com/vinix-os/mlibc.git'
    branch: 'master'
    commit: '4cff8ea22e4dcd25bcce90d00ac5b93a6c51d9d8'
    rolling_version: true
    version: '0.0pl@ROLLING_ID@'

  - name: v
    subdir: '3rdparty'
    git: 'https://github.com/vlang/v.git'
    branch: 'master'
    commit: '4ef9e2c05aeb215e6b467b259f1efa5572c18807'
    rolling_version: true
    version: '0.0pl@ROLLING_ID@'
    regenerate:
      - args: |
          set -e
          curl -o v.c https://raw.githubusercontent.com/vlang/vc/324b69c934d0dbd04a08d5d1a132c49bbf296fcb/v.c

  - name: limine
    subdir: '3rdparty'
    git: 'https://github.com/limine-bootloader/limine.git'
    tag: 'v3.5'
    version: '3.5'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
    regenerate:
      - args: ['./autogen.sh']
        environ:
          NOCONFIGURE: 'yes'

  - name: nasm
    subdir: '3rdparty'
    git: 'https://github.com/netwide-assembler/nasm.git'
    tag: 'nasm-2.15.05'
    version: '2.15.05'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
    regenerate:
      - args: ['./autogen.sh']

  - name: bison
    subdir: '3rdparty'
    git: 'https://git.savannah.gnu.org/git/bison.git'
    tag: 'v3.6.2'
    version: '3.6.2'
    sources_required: ['gnulib']
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
    regenerate:
      - args: ['rm', '-rf', 'gnulib']
      - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
      - args: ['git', 'submodule', 'update', '--init']
      - args: ['./bootstrap']
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
          '@THIS_SOURCE_DIR@/build-aux/']

  - name: gettext
    subdir: '3rdparty'
    git: 'https://git.savannah.gnu.org/git/gettext.git'
    tag: 'v0.19.8'
    version: '0.19.8'
    sources_required: ['gnulib']
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
    regenerate:
      - args: 'sed -i s/"SUBDIRS = doc intl intl-java intl-csharp gnulib-lib \$(SUBDIR_libasprintf)\ src po man m4 tests"/"SUBDIRS = intl intl-java intl-csharp gnulib-lib \$(SUBDIR_libasprintf)\ src po m4 tests"/ @THIS_SOURCE_DIR@/gettext-runtime/Makefile.am'
      - args: 'sed -i s/"SUBDIRS = doc intl gnulib-lib libgrep src libgettextpo po projects styles misc man m4 tests gnulib-tests examples its"/"SUBDIRS = intl gnulib-lib libgrep src libgettextpo po projects styles misc m4 tests gnulib-tests examples its"/ @THIS_SOURCE_DIR@/gettext-tools/Makefile.am'
      - args: ['rm', '-rf', 'gnulib']
      - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
      - args: ['./autogen.sh']
        environ:
          NOCONFIGURE: 'yes'

  - name: cmake
    subdir: '3rdparty'
    git: 'https://github.com/Kitware/CMake.git'
    tag: 'v3.23.1'
    version: '3.23.1'

  - name: xorg-util-macros
    subdir: '3rdparty'
    git: 'https://gitlab.freedesktop.org/xorg/util/macros.git'
    tag: 'util-macros-1.19.3'
    version: '1.19.3'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
    regenerate:
      - args: ['./autogen.sh']
        environ:
          NOCONFIGURE: 'yes'

  - name: file
    subdir: 3rdparty
    git: 'https://github.com/file/file.git'
    tag: 'FILE5_41'
    version: '5.41'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
    regenerate:
      - args: ['autoreconf', '-f', '-i']

  - name: doomgeneric
    subdir: 3rdparty
    git: 'https://github.com/ozkl/doomgeneric.git'
    branch: 'master'
    commit: '2d9b24f07c78c36becf41d89db30fa99863463e5'
    rolling_version: true
    version: '0.0pl@ROLLING_ID@'

  - name: ncurses
    subdir: '3rdparty'
    git: 'https://github.com/ThomasDickey/ncurses-snapshots.git'
    tag: 'v6_3_20220507'
    version: '6.3.20220507'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
    regenerate:
      - args: ['cp',
          '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
          '@THIS_SOURCE_DIR@/']

tools:
  - name: host-bison
    from_source: bison
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install-strip']

  - name: host-gettext
    from_source: gettext
    exports_aclocal: true
    tools_required:
      - host-bison
      - host-autoconf-v2.69
      - host-automake-v1.16
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
    compile:
      - args: ['make']
    install:
      - args: ['make', 'install-strip']

  - name: host-tar
    from_source: tar
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    configure:
      - args: ['@THIS_SOURCE_DIR@/configure', '--prefix=@PREFIX@']
        environ:
          CFLAGS: '-Wno-error -O2 -pipe'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install-strip']

  - name: host-autoconf-v2.69
    source:
      name: autoconf-v2.69
      subdir: '3rdparty'
      url: 'https://ftp.gnu.org/gnu/autoconf/autoconf-2.69.tar.gz'
      format: 'tar.gz'
      extract_path: 'autoconf-2.69'
      version: '2.69'
    configure:
      - args: ['@THIS_SOURCE_DIR@/configure', '--prefix=@PREFIX@']
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install']

  - name: host-automake-v1.16
    source:
      name: automake-v1.16
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/automake.git'
      tag: 'v1.16.5'
      version: '1.16.5'
      tools_required:
        - host-autoconf-v2.69
      regenerate:
        - args: ['./bootstrap']
        - args: |
            set -e
            git clone https://github.com/autoconf-archive/autoconf-archive.git --branch=v2022.02.11 --depth=1
    tools_required:
      - host-autoconf-v2.69
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
    compile:
      - args: |
          set -e
          export PATH="`pwd`/bin:$PATH"
          make bin/aclocal-1.16 bin/automake-1.16 -j@PARALLELISM@
          make -j@PARALLELISM@
    install:
      - args: ['make', 'install-strip']
      - args: ['ln', '-sf', '@PREFIX@/share/aclocal-1.16', '@PREFIX@/share/aclocal']
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/autoconf-archive/m4/.', '@PREFIX@/share/aclocal-1.16/']

  - name: host-tic
    from_source: ncurses
    configure:
      - args: ['@THIS_SOURCE_DIR@/configure']
    compile:
      - args: ['make', '-C', 'include']
      - args: ['make', '-C', 'progs', 'tic']
    install:
      - args: ['mkdir', '-p', '@PREFIX@/bin']
      - args: ['cp', 'progs/tic', '@PREFIX@/bin/']

  - name: host-zic
    from_source: tzdata
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
    compile:
      - args: ['make', 'zic']
    install:
      - args: ['mkdir', '-p', '@PREFIX@/bin']
      - args: ['cp', 'zic', '@PREFIX@/bin/']

  - name: host-pkg-config
    exports_aclocal: true
    from_source: pkg-config
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
        - '--with-internal-glib'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install-strip']

  - name: host-v
    from_source: v
    compile:
      - args: |
          set -e
          rm -rf "@PREFIX@/v"
          mkdir -p "@PREFIX@/v"
          cp -r "@THIS_SOURCE_DIR@/." "@PREFIX@/v/"
          cd "@PREFIX@/v"
          rm -v *.xbstrap
          cc -O2 -pipe -w -std=gnu99 -fno-strict-aliasing v.c -o v -lm -lpthread
          mkdir -p "@PREFIX@/bin"
          ln -sf "@PREFIX@/v/v" "@PREFIX@/bin/v"

  - name: host-limine
    from_source: limine
    tools_required:
      - host-gcc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
        - 'TOOLCHAIN=x86_64-vinix'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install-strip']

  - name: host-binutils
    from_source: binutils
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
        - '--target=x86_64-vinix'
        - '--with-sysroot=@SYSROOT_DIR@'
        # On recent compilers, binutils 2.26 causes implicit-fallthrough warnings, among others.
        - '--disable-werror'
        - '--enable-targets=x86_64-elf,x86_64-pe'
        # -g blows up the binary size.
        - 'CFLAGS=-O2 -pipe'
    compile:
      - args: ['make', '-j@PARALLELISM@', 'all-binutils', 'all-gas', 'all-ld']
    install:
      - args: ['make', 'install-strip-binutils', 'install-strip-gas', 'install-strip-ld']

  - name: host-gcc
    from_source: gcc
    tools_required:
      - tool: host-binutils
        recursive: true
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
        - '--target=x86_64-vinix'
        - '--with-sysroot=@SYSROOT_DIR@'
        - '--enable-languages=c,c++'
        - '--disable-multilib'
        - '--enable-initfini-array'
        # -g blows up GCC's binary size.
        - 'CFLAGS=-O2 -pipe'
        - 'CXXFLAGS=-O2 -pipe'
    stages:
      - name: compiler
        pkgs_required:
          - mlibc-headers
        compile:
          - args: ['make', '-j@PARALLELISM@', 'all-gcc']
        install:
          - args: ['make', 'install-gcc']
          # GCC does *not* look for target-prefixed LD/AS.
          # Instead, it searches a list of prefix directories. Link AS/LD to make it happy.
          - args: ['mkdir', '-p', '@PREFIX@/x86_64-vinix/bin']
          - args: ['ln', '-sf', '../../../host-binutils/x86_64-vinix/bin/as',
                               '@PREFIX@/x86_64-vinix/bin/as']
          - args: ['ln', '-sf', '../../../host-binutils/x86_64-vinix/bin/ld',
                               '@PREFIX@/x86_64-vinix/bin/ld']
      - name: libgcc
        tools_required:
          - tool: host-gcc
            stage_dependencies: [compiler]
        pkgs_required:
          - mlibc
        compile:
          - args: ['make', '-j@PARALLELISM@', 'all-target-libgcc']
        install:
          - args: ['make', 'install-strip-target-libgcc']

      - name: libstdc++
        tools_required:
          - tool: host-gcc
            stage_dependencies: [libgcc]
        compile:
          - args: ['make', '-j@PARALLELISM@', 'all-target-libstdc++-v3']
        install:
          - args: ['make', 'install-strip-target-libstdc++-v3']

  - name: host-libtool
    exports_aclocal: true
    source:
      name: libtool
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/libtool.git'
      tag: 'v2.4.7'
      version: '2.4.7'
      sources_required: ['gnulib']
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
      regenerate:
        - args: ['rm', '-rf', 'gnulib']
        - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
        - args: ['./bootstrap']
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install-strip']

  - name: host-cmake
    from_source: cmake
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/bootstrap'
        - '--prefix=@PREFIX@'
        - '--parallel=@PARALLELISM@'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install']
      - args: |
          set -e
          echo 'include(Platform/UnixPaths)' > "@PREFIX@/share/cmake-3.23/Modules/Platform/Vinix.cmake"

  - name: host-xorg-macros
    exports_aclocal: true
    from_source: xorg-util-macros
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install-strip']

  - name: host-xorg-font-util
    exports_aclocal: true
    from_source: xorg-font-util
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install-strip']

  - name: host-xtrans
    exports_aclocal: true
    from_source: libxtrans
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install-strip']

  - name: host-file
    from_source: file
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--prefix=@PREFIX@'
    compile:
      - args: ['make', '-j@PARALLELISM@']
    install:
      - args: ['make', 'install-strip']

tasks:
  - name: make-basic-iso
    tools_required:
      - host-limine
      - host-tar
    pkgs_required:
      - base-files
      - kernel
      - init
      - util-vinix
      - bash
      - coreutils
    args:
      - name: vinix.iso
        path: '@BUILD_ROOT@'
    args:
      - '@SOURCE_ROOT@/build-support/make-iso.sh'
      - '@BUILD_ROOT@'
      - '@SOURCE_ROOT@'
      - '@SYSROOT_DIR@'
    workdir: '@BUILD_ROOT@'

  - name: make-iso
    tools_required:
      - host-limine
      - host-tar
    pkgs_required:
      - base-files
      - kernel
      - init
      - util-vinix
      - socket-test
      - bash
      - v
      - coreutils
      - less
      - nano
      - tzdata
      - diffutils
      - sed
      - binutils
      - gcc
      - gawk
      - vim
      - grep
      - file
    artifact_files:
      - name: vinix.iso
        path: '@BUILD_ROOT@'
    args:
      - '@SOURCE_ROOT@/build-support/make-iso.sh'
      - '@BUILD_ROOT@'
      - '@SOURCE_ROOT@'
      - '@SYSROOT_DIR@'
    workdir: '@BUILD_ROOT@'

packages:
  - name: base-files
    source:
      subdir: ''
      git: 'https://github.com/vlang/vinix.git'
      branch: 'main'
      rolling_version: true
      version: '0.0pl@ROLLING_ID@'
    build:
      - args: |
          set -e
          cp -rv "@THIS_SOURCE_DIR@/." "@THIS_COLLECT_DIR@/"
          rm -v "@THIS_COLLECT_DIR@/"*.xbstrap

  - name: kernel
    source:
      subdir: ''
      git: 'https://github.com/vlang/vinix.git'
      branch: 'main'
      rolling_version: true
      version: '0.0pl@ROLLING_ID@'
    tools_required:
      - host-v
      - host-gcc
    pkgs_required:
      - mlibc
    build:
      - args: |
          set -e
          cd "@THIS_SOURCE_DIR@"
          make PROD=@OPTION:prod@ CC=x86_64-vinix-gcc LD=x86_64-vinix-ld OBJDUMP=x86_64-vinix-objdump
          make install PREFIX=/boot DESTDIR="@THIS_COLLECT_DIR@"

  - name: init
    source:
      subdir: ''
      git: 'https://github.com/vlang/vinix.git'
      branch: 'main'
      rolling_version: true
      version: '0.0pl@ROLLING_ID@'
    tools_required:
      - host-v
      - host-gcc
    pkgs_required:
      - mlibc
    build:
      - args: |
          set -e
          cd "@THIS_SOURCE_DIR@"
          VCROSS_COMPILER_NAME=x86_64-vinix-gcc v -os vinix .
          mkdir -p "@THIS_COLLECT_DIR@/sbin"
          cp init "@THIS_COLLECT_DIR@/sbin/"

  - name: util-vinix
    source:
      subdir: ''
      git: 'https://github.com/vlang/vinix.git'
      branch: 'main'
      rolling_version: true
      version: '0.0pl@ROLLING_ID@'
    tools_required:
      - host-v
      - host-gcc
    pkgs_required:
      - mlibc
    build:
      - args: |
          set -e
          cd "@THIS_SOURCE_DIR@"
          make -j@PARALLELISM@ PROD=@OPTION:prod@ CC=x86_64-vinix-gcc
          make install PREFIX="/usr" DESTDIR="@THIS_COLLECT_DIR@"

  - name: socket-test
    source:
      subdir: '3rdparty'
      git: 'https://github.com/streaksu/socket_test.git'
      branch: 'main'
      rolling_version: true
      version: '0.0pl@ROLLING_ID@'
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    build:
      - args: |
          set -e
          cd "@THIS_SOURCE_DIR@"
          make -j@PARALLELISM@ CC=x86_64-vinix-gcc
          make install PREFIX="/usr" DESTDIR="@THIS_COLLECT_DIR@"

  - name: glib
    from_source: glib
    tools_required:
      - host-gcc
      - host-libtool
      - host-pkg-config
      - virtual: pkgconfig-for-target
        triple: "x86_64-vinix"
    pkgs_required:
      - mlibc
      - pcre
      - libffi
      - zlib
      - libiconv
      - libintl
    configure:
      - args:
        - 'meson'
        - '--cross-file'
        - '@SOURCE_ROOT@/build-support/cross_file.txt'
        - '--prefix=/usr'
        - '--libdir=lib'
        - '--buildtype=release'
        - '-Dxattr=false'
        - '@THIS_SOURCE_DIR@'
        environ:
          PKG_CONFIG_SYSROOT_DIR: '@BUILD_ROOT@/system-root'
          PKG_CONFIG_LIBDIR: '@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: mlibc-headers
    from_source: mlibc
    implict_package: true
    configure:
      - args:
        - 'meson'
        - '--cross-file'
        - '@SOURCE_ROOT@/build-support/cross_file.txt'
        - '--prefix=/usr'
        - '-Dheaders_only=true'
        - '-Ddisable_iconv_option=true'
        - '-Ddisable_intl_option=true'
        - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: mlibc
    from_source: mlibc
    tools_required:
      - tool: host-gcc
        stage_dependencies: [compiler]
    implict_package: true
    pkgs_required:
      - mlibc-headers
    configure:
      - args:
        - 'meson'
        - '--cross-file'
        - '@SOURCE_ROOT@/build-support/cross_file.txt'
        - '--prefix=/usr'
        - '--libdir=lib'
        - '--buildtype=debugoptimized'
        - '-Dmlibc_no_headers=true'
        - '-Ddisable_iconv_option=true'
        - '-Ddisable_intl_option=true'
        - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: less
    source:
      subdir: '3rdparty'
      url: 'https://www.greenwoodsoftware.com/less/less-590.tar.gz'
      format: 'tar.gz'
      extract_path: 'less-590'
      version: '590'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
    pkgs_required:
      - mlibc
      - ncurses
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install-strip']

  - name: nasm
    from_source: nasm
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
      - args:
        - './configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
    build:
      - args: ['make']
      - args: ['make', 'strip']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']

  - name: llvm
    from_source: llvm
    tools_required:
      - host-cmake
      - host-gcc
    pkgs_required:
      - mlibc
      - zlib
    configure:
      - args:
        - 'cmake'
        - '-GNinja'
        - '-DCMAKE_TOOLCHAIN_FILE=@SOURCE_ROOT@/build-support/CMakeToolchain.txt'
        - '-DCMAKE_INSTALL_PREFIX=/usr'
        # We really have to build LLVM in Release mode.
        # Building it in debug mode produces tens of GiB of debugging info.
        - '-DCMAKE_BUILD_TYPE=Release'
        - '-DLLVM_LINK_LLVM_DYLIB=ON'
        # RTTI affects the ABI. Hence, we enable it.
        - '-DLLVM_ENABLE_RTTI=ON'
        - '-DLLVM_TARGETS_TO_BUILD=X86'
        - '-DLLVM_TARGET_ARCH=x86_64'
        - '-DLLVM_DEFAULT_TARGET_TRIPLE=x86_64-vinix'
        - '-DLLVM_HOST_TRIPLE=x86_64-vinix'
        # Disable linking against ncurses, which we do not build with -fPIC.
        - '-DLLVM_ENABLE_TERMINFO=OFF'
        # Suppress developer warnings
        - '-Wno-dev'
        - '@THIS_SOURCE_DIR@/llvm'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: ncurses
    from_source: ncurses
    tools_required:
      - host-gcc
      - host-tic
      - host-automake-v1.16
      - host-autoconf-v2.69
      - host-pkg-config
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--without-ada'
        - '--enable-pc-files'
        - '--with-shared'
        - '--without-normal'
        - '--with-manpage-format=normal'
        - '--with-termlib'
        - '--enable-widec'
        environ:
          cf_cv_func_nanosleep: 'yes'
          PKG_CONFIG_SYSROOT_DIR: '@BUILD_ROOT@/system-root'
          PKG_CONFIG_LIBDIR: '@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install', 'PKG_CONFIG_LIBDIR=/usr/share/pkgconfig']
      # As we build ncurses with wide character support, make some compatibility links
      - args: |
          set -e
          mkdir -p "@THIS_COLLECT_DIR@/usr/lib/pkgconfig"
          for lib in ncurses form panel menu tinfo ; do
              rm -vf                    @THIS_COLLECT_DIR@/usr/lib/lib${lib}.so
              echo "INPUT(-l${lib}w)" > @THIS_COLLECT_DIR@/usr/lib/lib${lib}.so
              ln -sfv ${lib}w.pc        @THIS_COLLECT_DIR@/usr/lib/pkgconfig/${lib}.pc
          done
          rm -vf                     @THIS_COLLECT_DIR@/usr/lib/libcursesw.so
          echo "INPUT(-lncursesw)" > @THIS_COLLECT_DIR@/usr/lib/libcursesw.so
          ln -sfv libncurses.so      @THIS_COLLECT_DIR@/usr/lib/libcurses.so

  - name: xorg-util-macros
    from_source: xorg-util-macros
    tools_required:
      - host-gcc
      - host-xorg-macros
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xorg-proto
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/proto/xorgproto.git'
      tag: 'xorgproto-2022.1'
      version: '2022.1'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxau
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxau.git'
      tag: 'libXau-1.0.9'
      version: '1.0.9'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxdmcp
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxdmcp.git'
      tag: 'libXdmcp-1.1.3'
      version: '1.1.3'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libxau
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xcb-proto
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/proto/xcbproto.git'
      tag: 'xcb-proto-1.15'
      version: '1.15'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libxau
      - libxdmcp
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['sed', '-i', 's|${pc_sysrootdir}${PYTHON_PREFIX}|/usr|g', '@THIS_COLLECT_DIR@/usr/lib/pkgconfig/xcb-proto.pc']

  - name: libxcb
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxcb.git'
      tag: 'libxcb-1.15'
      version: '1.15'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libxau
      - libxdmcp
      - xcb-proto
    configure:
      - args: ['sed', '-i', "s/pthread-stubs//", '@THIS_SOURCE_DIR@/configure']
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--without-doxygen'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxtrans
    from_source: libxtrans
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libxcb
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libx11
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libx11.git'
      tag: 'libX11-1.8'
      version: '1.8'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
        - host-xtrans
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libxcb
      - libxtrans
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--disable-ipv6'
        - '--disable-malloc0returnsnull'
        - '--with-keysymdefdir=@SYSROOT_DIR@/usr/include/X11'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxft
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxft.git'
      tag: 'libXft-2.3.4'
      version: '2.3.4'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxrender
      - freetype
      - fontconfig
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxrender
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxrender.git'
      tag: 'libXrender-0.9.10'
      version: '0.9.10'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--disable-malloc0returnsnull'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxext
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxext.git'
      tag: 'libXext-1.3.4'
      version: '1.3.4'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--disable-malloc0returnsnull'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxrandr
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxrandr.git'
      tag: 'libXrandr-1.5.2'
      version: '1.5.2'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
      - libxrender
      - libxext
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--disable-malloc0returnsnull'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxshmfence
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxshmfence.git'
      tag: 'libxshmfence-1.3'
      version: '1.3'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxxf86vm
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxxf86vm.git'
      tag: 'libXxf86vm-1.1.4'
      version: '1.1.4'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
      - libxext
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--disable-malloc0returnsnull'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxkbfile
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxkbfile.git'
      tag: 'libxkbfile-1.1.0'
      version: '1.1.0'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xorg-font-util
    from_source: xorg-font-util
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libfontenc
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libfontenc.git'
      tag: 'libfontenc-1.1.4'
      version: '1.1.4'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
        - host-xorg-font-util
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
      - xorg-font-util
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxfont2
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxfont.git'
      tag: 'libXfont2-2.0.5'
      version: '2.0.5'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
        - host-xtrans
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
      - host-xtrans
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
      - freetype
      - fontconfig
      - bzip2
      - libfontenc
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--with-bzip2'
        - '--disable-devel-docs'
        # strcasecmp is implicitly declared, probably an missing include somewhere, so disable -Werror for that
        - '--disable-selective-werror'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libepoxy
    source:
      subdir: '3rdparty'
      git: 'https://github.com/anholt/libepoxy.git'
      tag: '1.5.10'
      version: '1.5.10'
    tools_required:
      - host-pkg-config
      - host-gcc
      - virtual: pkgconfig-for-target
        triple: "x86_64-vinix"
    pkgs_required:
      - mlibc
      - mesa
      - xorg-proto
      - libx11
    configure:
      - args:
          - 'meson'
          - '--cross-file'
          - '@SOURCE_ROOT@/build-support/cross_file.txt'
          - '--prefix=/usr'
          - '--buildtype=release'
          - '-Degl=no'
          - '-Dtests=false'
          - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxfixes
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxfixes.git'
      tag: 'libXfixes-6.0.0'
      version: '6.0.0'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxdamage
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxdamage.git'
      tag: 'libXdamage-1.1.5'
      version: '1.1.5'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
      - libxfixes
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxv
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxv.git'
      tag: 'libXv-1.0.11'
      version: '1.0.11'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxext
      - libxfixes
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--disable-malloc0returnsnull'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxi
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxi.git'
      tag: 'libXi-1.8'
      version: '1.8'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
      - libxext
      - libxfixes
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--disable-malloc0returnsnull'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: gmp
    source:
      subdir: '3rdparty'
      hg: 'https://gmplib.org/repo/gmp-6.2/'
      tag: 'gmp-6.2.1'
      version: '6.2.1'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
      regenerate:
        - args: ['@THIS_SOURCE_DIR@/.bootstrap']
        - args: ['cp', '@THIS_SOURCE_DIR@/configfsf.guess', '@THIS_SOURCE_DIR@/config.guess']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/']
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--enable-cxx'
        - '--disable-static'
        - '--docdir=/usr/share/doc/gmp-6.2.0'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: nettle
    source:
      subdir: '3rdparty'
      git: 'https://github.com/gnutls/nettle.git'
      tag: 'nettle_3.7.3_release_20210606'
      version: '3.7.3'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
      regenerate:
        - args: ['./.bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/']
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
    pkgs_required:
      - mlibc
      - gmp
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-static'
        - '--disable-documentation'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xf86-video-fbdev
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/driver/xf86-video-fbdev.git'
      tag: 'xf86-video-fbdev-0.5.0'
      version: '0.5.0'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-server
      - xorg-util-macros
      - libx11
      - libxrandr
      - libxrender
      - libxv
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        - '--disable-pciaccess'
        environ:
          SYSROOT: '@SYSROOT_DIR@'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xf86-input-keyboard
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/driver/xf86-input-keyboard.git'
      tag: 'xf86-input-keyboard-1.9.0'
      version: '1.9.0'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-server
      - xorg-util-macros
      - libx11
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xkbcomp
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/app/xkbcomp.git'
      tag: 'xkbcomp-1.4.5'
      version: '1.4.5'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - libx11
      - libxkbfile
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xorg-server
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/xserver.git'
      tag: 'xorg-server-1.20.14'
      version: '1.20.14'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
        - host-xorg-font-util
        - host-xtrans
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xcb-proto
      - xorg-proto
      - libxshmfence
      - libx11
      - libxxf86vm
      - libxkbfile
      - libxfont2
      - libepoxy
      - libxi
      - libxv
      - libxdamage
      - libxrender
      - libxrandr
      - libxcb
      - libxfixes
      - libxext
      - nettle
      - xkbcomp
      - pixman
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        - '--with-xkb-output=/var/lib/xkb'
        - '--enable-xorg'
        - '--enable-xv'
        - '--enable-xvfb'
        - '--disable-xephyr'
        - '--disable-xwayland'
        - '--disable-xnest'
        - '--disable-dmx'
        - '--disable-suid-wrapper'
        - '--disable-pciaccess'
        - '--disable-dpms'
        - '--disable-screensaver'
        - '--disable-xres'
        - '--disable-xinerama'
        - '--disable-xvmc'
        - '--disable-systemd-logind'
        - '--disable-secure-rpc'
        - '--disable-config-udev'
        - '--disable-dri'
        - '--disable-dri2'
        - '--disable-dri3'
        - '--disable-vbe'
        - '--disable-int10-module'
        - '--disable-vgahw'
        - '--disable-libdrm'
        - '--disable-glamor'
        - '--disable-glx'
        environ:
          CFLAGS: '-Wno-error=array-bounds -O2 -pipe'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/etc/X11']
      - args: ['cp', '@SOURCE_ROOT@/extra-files/xorg/xorg.conf', '@THIS_COLLECT_DIR@/etc/X11/']

  - name: libffi
    source:
      subdir: '3rdparty'
      git: 'https://github.com/libffi/libffi.git'
      tag: 'v3.4.2'
      version: '3.4.2'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
      regenerate:
        - args: ['./autogen.sh']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/']
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libexpat
    source:
      subdir: '3rdparty'
      git: 'https://github.com/libexpat/libexpat.git'
      tag: 'R_2_4_8'
      version: '2.4.8'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
      regenerate:
        - args: ['./buildconf.sh']
          workdir: '@THIS_SOURCE_DIR@/expat'
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/expat/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        # We disable xmlwf to avoid building its documentation.
        - '--without-xmlwf'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: bash
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/bash.git'
      # Checkout bash 5.1 patch 16
      branch: 'master'
      commit: '9439ce094c9aa7557a9d53ac7b412a23aa66e36b'
      version: '5.1.16'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
      regenerate:
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/support/']
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
    pkgs_required:
      - mlibc
      - ncurses
      - libiconv
      - readline
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--without-bash-malloc'
        - '--disable-nls'
        environ:
          ac_cv_func_wcswidth: 'no'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install-strip']
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/bin']
      - args: ['ln', '-s', '/usr/bin/bash', '@THIS_COLLECT_DIR@/bin/bash']
      - args: ['ln', '-s', '/usr/bin/bash', '@THIS_COLLECT_DIR@/bin/sh']
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/etc/bash']
      - args: ['cp', '@SOURCE_ROOT@/extra-files/bash/profile', '@THIS_COLLECT_DIR@/etc/']
      - args: ['cp', '@SOURCE_ROOT@/extra-files/bash/bashrc', '@THIS_COLLECT_DIR@/etc/bash/']

  - name: v
    from_source: v
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    build:
      - args: |
          set -e
          mkdir -p "@THIS_COLLECT_DIR@/usr/v"
          cp -r "@THIS_SOURCE_DIR@/." "@THIS_COLLECT_DIR@/usr/v/"
          cd "@THIS_COLLECT_DIR@/usr/v"
          rm -v *.xbstrap
          x86_64-vinix-gcc -O2 -pipe -w -std=gnu99 -fno-strict-aliasing v.c -o v
          mkdir -p "@THIS_COLLECT_DIR@/usr/bin"
          ln -sf /usr/v/v "@THIS_COLLECT_DIR@/usr/bin/v"

  - name: mesa
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/mesa/mesa.git'
      tag: 'mesa-21.3.8'
      version: '21.3.8'
    tools_required:
      - host-pkg-config
      - host-gcc
      - virtual: pkgconfig-for-target
        triple: "x86_64-vinix"
      - virtual: pkgconfig-for-host
        program_name: host-pkg-config
    pkgs_required:
      - mlibc
      - llvm
      - zlib
      - libxshmfence
      - libxrandr
      - libxdamage
      - libxxf86vm
      - libxfixes
      - libx11
      - libxext
      - libxcb
      - libexpat
    configure:
      - args: ['cp', '@SOURCE_ROOT@/build-support/cross_file.txt', 'meson.cross-file']
      - args:
        - 'sed'
        - '-i'
        - "/^# sed adds binaries here.$/a llvm-config = '@SOURCE_ROOT@/build-support/cross-llvm-config'"
        - 'meson.cross-file'
      - args:
        - 'meson'
        - '--native-file'
        - '@SOURCE_ROOT@/build-support/native_file.txt'
        - '--cross-file'
        - 'meson.cross-file'
        - '--prefix=/usr'
        - '--libdir=lib'
        # The debug build type enables some additional output from Mesa.
        - '--buildtype=debugoptimized'
        - '-Dglx=gallium-xlib'
        - '-Dplatforms=x11'
        # The Gallium swrast driver seems to be preferred over dri-swrast.
        - '-Ddri-drivers='
        - '-Dgallium-drivers=swrast'
        - '-Dvulkan-drivers='
        # Force Mesa to build with LLVM.
        - '-Dllvm=enabled'
        - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: coreutils
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/coreutils.git'
      tag: 'v9.1'
      version: '9.1'
      sources_required: ['gnulib']
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
      regenerate:
        - args: ['rm', '-rf', 'gnulib']
        - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
        - args: ['./bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - tzdata
    configure:
      # Huge hack: coreutils does not compile the build-machine binary make-prime-list
      # using the build-machine compiler. Hence, build and invoke the binary manually here.
      - args:
        - '@THIS_SOURCE_DIR@/configure'
      - args: ['make', 'src/make-prime-list']
      - args: |
          set -e
          ./src/make-prime-list 5000 > "@THIS_SOURCE_DIR@/src/primes.h"
          rm -rf *
      # Now compile coreutils for the correct target.
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - 'CFLAGS=-DSLOW_BUT_NO_HACKS -Wno-error -O2 -pipe'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: nano
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/nano.git'
      tag: 'v6.3'
      version: '6.3'
      sources_required: ['gnulib']
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-pkg-config
      regenerate:
        - args: ['rm', '-rf', 'gnulib']
        - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
        - args: ['./autogen.sh']
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
      - file
      - ncurses
      - libintl
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - 'CFLAGS=-DSLOW_BUT_NO_HACKS'
        - 'LDFLAGS=-Wl,--copy-dt-needed-entries'
        environ:
          PKG_CONFIG_SYSROOT_DIR: '@BUILD_ROOT@/system-root'
          PKG_CONFIG_LIBDIR: '@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig'
          gl_cv_type_wctype_t: 'yes'
          gl_cv_type_wctrans_t: 'yes'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/etc']
      - args: ['cp', '@SOURCE_ROOT@/extra-files/nano/nanorc', '@THIS_COLLECT_DIR@/etc/']

  - name: tzdata
    from_source: tzdata
    tools_required:
      - host-zic
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@/']
    build:
      # Build and install support programs
      - args: ['make', 'CC=x86_64-vinix-gcc', 'AR=x86_64-vinix-ar']
      - args: ['make', 'install', 'DESTDIR=@THIS_COLLECT_DIR@', 'ZIC=zic']
      # Create the required directories
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/etc']
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix']
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/usr/share/zoneinfo/right']
      # Create the time zone files without leap seconds, convention puts these in both zoneinfo and zoneinfo/posix.
      # After that. create time time zone files with leap seconds
      - args: |
          set -e
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo "@THIS_BUILD_DIR@"/etcetera
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/posix "@THIS_BUILD_DIR@"/etcetera
          zic -L "@THIS_SOURCE_DIR@"/leapseconds -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/right "@THIS_BUILD_DIR@"/etcetera
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo "@THIS_BUILD_DIR@"/southamerica
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/posix "@THIS_BUILD_DIR@"/southamerica
          zic -L "@THIS_SOURCE_DIR@"/leapseconds -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/right "@THIS_BUILD_DIR@"/southamerica
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo "@THIS_BUILD_DIR@"/northamerica
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/posix "@THIS_BUILD_DIR@"/northamerica
          zic -L "@THIS_SOURCE_DIR@"/leapseconds -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/right "@THIS_BUILD_DIR@"/northamerica
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo "@THIS_BUILD_DIR@"/europe
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/posix "@THIS_BUILD_DIR@"/europe
          zic -L "@THIS_SOURCE_DIR@"/leapseconds -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/right "@THIS_BUILD_DIR@"/europe
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo "@THIS_BUILD_DIR@"/africa
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/posix "@THIS_BUILD_DIR@"/africa
          zic -L "@THIS_SOURCE_DIR@"/leapseconds -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/right "@THIS_BUILD_DIR@"/africa
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo "@THIS_BUILD_DIR@"/antarctica
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/posix "@THIS_BUILD_DIR@"/antarctica
          zic -L "@THIS_SOURCE_DIR@"/leapseconds -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/right "@THIS_BUILD_DIR@"/antarctica
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo "@THIS_BUILD_DIR@"/asia
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/posix "@THIS_BUILD_DIR@"/asia
          zic -L "@THIS_SOURCE_DIR@"/leapseconds -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/right "@THIS_BUILD_DIR@"/asia
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo "@THIS_BUILD_DIR@"/australasia
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/posix "@THIS_BUILD_DIR@"/australasia
          zic -L "@THIS_SOURCE_DIR@"/leapseconds -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/right "@THIS_BUILD_DIR@"/australasia
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo "@THIS_BUILD_DIR@"/backward
          zic -L /dev/null -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/posix "@THIS_BUILD_DIR@"/backward
          zic -L "@THIS_SOURCE_DIR@"/leapseconds -d "@THIS_COLLECT_DIR@"/usr/share/zoneinfo/right "@THIS_BUILD_DIR@"/backward
      # Create the posixrules file, POSIX requires daylight saving rules to be in accordance with US rules, thus use New York
      - args: ['zic', '-d', '@THIS_COLLECT_DIR@/usr/share/zoneinfo', '-p', 'America/New_York']
      # Default to UTC for localtime, this should be fixed, but that is pending xbstrap support.
      - args: ['ln', '-sf', '/usr/share/zoneinfo/UTC', '@THIS_COLLECT_DIR@/etc/localtime']

  - name: grep
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/grep.git'
      tag: 'v3.7'
      version: '3.7'
      sources_required: ['gnulib']
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-pkg-config
      regenerate:
        - args: ['rm', '-rf', 'gnulib']
        - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
        - args: ['./bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - host-gcc
      - host-pkg-config
    pkgs_required:
      - mlibc
      - pcre
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-nls'
      - args: 'sed -i s/-Werror//g @THIS_BUILD_DIR@/lib/Makefile'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: diffutils
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/diffutils.git'
      tag: 'v3.8'
      version: '3.8'
      sources_required: ['gnulib']
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-pkg-config
      regenerate:
        - args: ['rm', '-rf', 'gnulib']
        - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
        - args: ['./bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-nls'
        - '--disable-werror'
      - args: 'sed -i s/-Werror//g @THIS_BUILD_DIR@/lib/Makefile'
      - args: 'sed -i s/-Werror//g @THIS_BUILD_DIR@/src/Makefile'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: sed
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/sed.git'
      tag: 'v4.8'
      version: '4.8'
      sources_required: ['gnulib']
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
      regenerate:
        - args: ['rm', '-rf', 'gnulib']
        - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
        - args: ['./bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-nls'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: binutils
    from_source: binutils
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--target=x86_64-vinix'
        - '--with-sysroot=/'
        - '--disable-nls'
        # On recent compilers, binutils 2.26 causes implicit-fallthrough warnings, among others.
        - '--disable-werror'
        # -g blows up the binary size.
        - 'CFLAGS=-O2 -pipe'
    build:
      - args: ['make', '-j@PARALLELISM@', 'all-binutils', 'all-gas', 'all-ld']
      - args: ['make', 'install-strip-binutils', 'install-strip-gas', 'install-strip-ld']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: gcc
    from_source: gcc
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - binutils
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--target=x86_64-vinix'
        - '--with-sysroot=/'
        - '--with-build-sysroot=@SYSROOT_DIR@'
        - '--enable-languages=c,c++'
        - '--enable-initfini-array'
        - '--disable-multilib'
        - '--disable-nls'
        # -g blows up GCC's binary size.
        - 'CFLAGS=-O2 -pipe'
        - 'CXXFLAGS=-O2 -pipe'
    build:
      - args: ['make', '-j@PARALLELISM@', 'all-gcc', 'all-target-libgcc']
      - args: ['make', 'install-strip-gcc', 'install-strip-target-libgcc']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['sh', '-c', 'cp -rv @BUILD_ROOT@/tools/host-gcc/x86_64-vinix/lib/* @THIS_COLLECT_DIR@/usr/lib/']
      - args: ['sh', '-c', 'cp -rv @BUILD_ROOT@/tools/host-gcc/x86_64-vinix/include/* @THIS_COLLECT_DIR@/usr/include/']
      - args: ['ln', '-s', '/usr/bin/gcc', '@THIS_COLLECT_DIR@/usr/bin/cc']

  - name: gawk
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/gawk.git'
      tag: 'gawk-5.1.0'
      version: '5.1.0'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
      regenerate:
        - args: sed -i 's/extras//' @THIS_SOURCE_DIR@/Makefile.in
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/']
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-nls'
        - '--disable-extensions'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: pcre
    source:
      subdir: '3rdparty'
      git: 'https://github.com/vinix-os/pcre.git'
      tag: '1767'
      # Seems to be 8.45?
      version: '8.45'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
      regenerate:
        - args: ['./autogen.sh']
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        - '--enable-unicode-properties'
        - '--enable-pcre8'
        - '--enable-pcre16'
        - '--enable-pcre32'
        - '--disable-static'
        environ:
          PKG_CONFIG_SYSROOT_DIR: '@BUILD_ROOT@/system-root'
          PKG_CONFIG_LIBDIR: '@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install-strip']

  - name: freetype
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/freetype/freetype.git'
      tag: 'VER-2-12-1'
      version: '2.12.1'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: '1'
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/builds/unix/']
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - bzip2
      - libpng
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-static'
        - '--with-harfbuzz=no'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libpng
    source:
      subdir: '3rdparty'
      git: 'https://git.code.sf.net/p/libpng/code'
      tag: 'v1.6.37'
      version: '1.6.37'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
      regenerate:
        - args: ['git', 'clean', '-xf', '-e', '*.xbstrap']
        - args: ['autoreconf', '-fvi']
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xz-utils
    source:
      subdir: '3rdparty'
      git: 'https://git.tukaani.org/xz.git'
      tag: 'v5.2.5'
      version: '5.2.5'
      disable_shallow_fetch: true
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
      regenerate:
        - args: ['./autogen.sh', '--no-po4a']
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-gcc
    pkgs_required:
      - mlibc
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-static'
        - '--disable-nls'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: bzip2
    source:
      subdir: '3rdparty'
      git: 'https://sourceware.org/git/bzip2.git'
      tag: 'bzip2-1.0.8'
      version: '1.0.8'
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
      # Remove the test directory from the Makefile, as it tries to run (and fail on) the tests
      - args: 'sed -i s/"all: libbz2.a bzip2 bzip2recover test"/"all: libbz2.a bzip2 bzip2recover"/ @THIS_BUILD_DIR@/Makefile'
    build:
      # Building Makefile-libbz2_so first makes all programs link agains libbz2.so
      - args: ['make', 'CC=x86_64-vinix-gcc', 'CFLAGS=-fPIC', '-f', 'Makefile-libbz2_so']
      - args: ['make', 'clean']
      - args: ['make', 'CC=x86_64-vinix-gcc', 'CFLAGS=-fPIC', '-j@PARALLELISM@']
      - args: ['make', 'PREFIX=@THIS_COLLECT_DIR@/usr', 'install']
      - args: ['ln', '-sf', 'bzdiff', '@THIS_COLLECT_DIR@/usr/bin/bzcmp']
      - args: ['ln', '-sf', 'bzgrep', '@THIS_COLLECT_DIR@/usr/bin/bzegrep']
      - args: ['ln', '-sf', 'bzgrep', '@THIS_COLLECT_DIR@/usr/bin/bzfgrep']
      - args: ['ln', '-sf', 'bzmore', '@THIS_COLLECT_DIR@/usr/bin/bzless']

  - name: zlib
    source:
      subdir: '3rdparty'
      git: 'https://github.com/madler/zlib.git'
      tag: 'v1.2.12'
      version: '1.2.12'
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        environ:
          CHOST: 'x86_64-vinix'
          prefix: '/usr'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: openssl
    source:
      subdir: '3rdparty'
      git: 'https://github.com/openssl/openssl.git'
      tag: 'OpenSSL_1_1_1o'
      version: '1.1.1o'
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/Configure'
        - '--prefix=/usr'
        - '--openssldir=/etc/ssl'
        - '--libdir=lib'
        - 'x86_64-vinix'
        - 'shared'
        - 'zlib-dynamic'
        - 'no-afalgeng'
        environ:
          CC: 'x86_64-vinix-gcc'
          CXX: 'x86_64-vinix-g++'
    build:
      - args: ['make', '-j@PARALLELISM@']
      # Disable installing static libraries
      - args: ['sed', '-i', '/INSTALL_LIBS/s/libcrypto.a libssl.a//', '@THIS_BUILD_DIR@/Makefile']
      # Suffix all man pages with ssl
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'MANSUFFIX=ssl', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      # Move the doc dir to a versioned directory
      - args: ['mv', '@THIS_COLLECT_DIR@/usr/share/doc/openssl', '@THIS_COLLECT_DIR@/usr/share/doc/openssl-1.1.1o']

  - name: wget
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/wget.git'
      tag: 'v1.21.3'
      version: '1.21.3'
      sources_required: ['gnulib']
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
      regenerate:
        - args: ['rm', '-rf', 'gnulib']
        - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
        - args: ['./bootstrap']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
    tools_required:
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - pcre
      - openssl
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--disable-nls'
        - '--with-ssl=openssl'
        - '--with-openssl'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: readline
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/readline.git'
      tag: 'readline-8.1'
      version: '8.1'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
      regenerate:
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/support/']
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - ncurses
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-static'
        - '--enable-multibyte'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'DESTDIR=@THIS_COLLECT_DIR@', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: cairo
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/cairo/cairo.git'
      tag: '1.16.0'
      version: '1.16.0'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
    pkgs_required:
      - mlibc
      - freetype
      - fontconfig
      - libpng
      - pixman
      - mesa
    configure:
      - args:
        # For now, we build without glesv2 backend as Weston prefers the image backend.
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        - '--disable-xlib'
        - '--enable-xml'
        - '--enable-tee'
        environ:
          # freetype-config does not support cross-compilation.
          FREETYPE_CONFIG: 'no'
          PKG_CONFIG_SYSROOT_DIR: '@BUILD_ROOT@/system-root'
          PKG_CONFIG_LIBDIR: '@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxkbcommon
    source:
      subdir: '3rdparty'
      git: 'https://github.com/xkbcommon/libxkbcommon.git'
      tag: 'xkbcommon-1.4.0'
      version: '1.4.0'
    tools_required:
      - host-pkg-config
      - host-gcc
      - virtual: pkgconfig-for-host
        program_name: host-pkg-config
      - virtual: pkgconfig-for-target
        triple: "x86_64-vinix"
    pkgs_required:
      - mlibc
      - libxcb
      - libxml
      - xkeyboard-config
    configure:
      - args:
        - 'meson'
        - '--native-file'
        - '@SOURCE_ROOT@/build-support/native_file.txt'
        - '--cross-file'
        - '@SOURCE_ROOT@/build-support/cross_file.txt'
        - '--prefix=/usr'
        - '--libdir=lib'
        - '--buildtype=release'
        - '-Denable-docs=false'
        - '-Denable-x11=true'
        - '-Denable-wayland=false'
        - '@THIS_SOURCE_DIR@'
    build:
      - args: ['ninja']
      - args: ['ninja', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
      - args: ['mkdir', '-p', "@THIS_COLLECT_DIR@/usr/share/X11/xkb"]

  - name: libice
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libice.git'
      tag: 'libICE-1.0.10'
      version: '1.0.10'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
        - host-xtrans
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libsm
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libsm.git'
      tag: 'libSM-1.2.3'
      version: '1.2.3'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
        - host-xtrans
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-gcc
      - host-pkg-config
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
      - libice
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxt
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxt.git'
      tag: 'libXt-1.2.1'
      version: '1.2.1'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxtrans
      - libsm
      - libice
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
        - '--disable-malloc0returnsnull'
        - '--with-appdefaultdir=/etc/X11/app-defaults'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxpm
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxpm.git'
      tag: 'libXpm-3.5.13'
      version: '3.5.13'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxext
      - libxt
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxmu
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxmu.git'
      tag: 'libXmu-1.1.3'
      version: '1.1.3'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
        - host-xtrans
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxext
      - libxtrans
      - libxt
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxaw
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/lib/libxaw.git'
      tag: 'libXaw-1.0.14'
      version: '1.0.14'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxext
      - libxt
      - libxmu
      - libxpm
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xkbutils
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/app/xkbutils.git'
      tag: 'xkbutils-1.0.4'
      version: '1.0.4'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['autoreconf', '-vfi']
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - xorg-util-macros
      - xorg-proto
      - libx11
      - libxt
      - libxaw
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xkeyboard-config
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xkeyboard-config/xkeyboard-config.git'
      tag: 'xkeyboard-config-2.34'
      version: '2.34'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
      - host-xorg-macros
      - host-gcc
    pkgs_required:
      - mlibc
      - libx11
      - xorg-proto
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--with-xkb-rules-symlink=xorg'
        - '--disable-nls'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xclock
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/app/xclock.git'
      tag: 'xclock-1.1.1'
      version: '1.1.1'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
        - host-gettext
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - libx11
      - libxmu
      - libxaw
      - libxrender
      - libxft
      - libxt
      - libxkbfile
      - libiconv
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-selective-werror' # strncasecmp
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: xeyes
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/xorg/app/xeyes.git'
      tag: 'xeyes-1.2.0'
      version: '1.2.0'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
        - host-xorg-macros
        - host-gettext
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - libx11
      - libxmu
      - libxaw
      - libxrender
      - libxft
      - libxt
      - libxkbfile
      - libiconv
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-selective-werror' # strncasecmp
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: pixman
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/pixman/pixman.git'
      tag: 'pixman-0.40.0'
      version: '0.40.0'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-libtool
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - libpng
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: fontconfig
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.freedesktop.org/fontconfig/fontconfig.git'
      tag: '2.14.0'
      version: '2.14.0'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
        # Make sure we regenerate this file
        - args: ['rm', '-f', 'src/fcobjshash.h']
    pkgs_required:
      - mlibc
      - freetype
      - libxml
      - libiconv
    tools_required:
      - host-autoconf-v2.69
      - host-automake-v1.16
      - host-gcc
      - host-libtool
      - host-pkg-config
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--sysconfdir=/etc'
        - '--localstatedir=/var'
        - '--disable-docs'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        - '--enable-libxml2'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libxml
    source:
      subdir: '3rdparty'
      git: 'https://gitlab.gnome.org/GNOME/libxml2.git'
      tag: 'v2.9.14'
      version: '2.9.14'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
      regenerate:
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - zlib
      - python
      - libiconv
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--with-python=@SYSROOT_DIR@/usr/bin/python3.8'
        - '--disable-static'
        - '--with-threads'
        - '--disable-ipv6'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: python
    from_source: python
    tools_required:
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - zlib
      - libexpat
      - libffi
      - ncurses
      - readline
      - bzip2
      - openssl
      - xz-utils
      - libintl
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--build=x86_64-linux-gnu'
        - '--prefix=/usr'
        - '--enable-shared'
        - '--with-system-ffi'
        - '--with-system-expat'
        - '--disable-ipv6'
        - '--without-ensurepip'
        environ:
          PKG_CONFIG_SYSROOT_DIR: '@BUILD_ROOT@/system-root'
          PKG_CONFIG_LIBDIR: '@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig'
          ac_cv_file__dev_ptmx: 'no'
          ac_cv_file__dev_ptc: 'no'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libiconv
    source:
      subdir: '3rdparty'
      git: 'https://git.savannah.gnu.org/git/libiconv.git'
      # Last release tag is broken for us, use current master (07-12-2020)
      branch: 'master'
      commit: '0eb1068ceb77ba383c3ce2fc391ab40ef686c491'
      version: '1.16'
      sources_required: ['gnulib']
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
        - host-pkg-config
      regenerate:
        - args: ['rm', '-rf', 'gnulib']
        - args: ['cp', '-r', '@SOURCE_ROOT@/3rdparty/gnulib', './']
        # Gnulib broke on commit e3174b6d1fdbe6ea2297bf8c8333f65f9d9d9588, so check out the one before that.
        - args: ['git', 'checkout', '766ec17a90f67e8cda78394e58a7fffb00f5a4b7']
          workdir: '@THIS_SOURCE_DIR@/gnulib'
        - args: ['./autogen.sh']
          environ:
            NOCONFIGURE: 'yes'
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/build-aux/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub',
            '@THIS_SOURCE_DIR@/libcharset/build-aux/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-libtool/share/aclocal/libtool.m4',
            '@THIS_SOURCE_DIR@/m4/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-libtool/share/aclocal/libtool.m4',
            '@THIS_SOURCE_DIR@/libcharset/m4/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-libtool/share/libtool/build-aux/ltmain.sh',
            '@THIS_SOURCE_DIR@/libcharset/build-aux/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-libtool/share/libtool/build-aux/ltmain.sh',
            '@THIS_SOURCE_DIR@/build-aux/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-libtool/share/aclocal/ltversion.m4',
            '@THIS_SOURCE_DIR@/m4/']
        - args: ['cp',
            '@BUILD_ROOT@/tools/host-libtool/share/aclocal/ltversion.m4',
            '@THIS_SOURCE_DIR@/libcharset/m4/']
        - args: ['autoreconf', '-fvi', '-I@THIS_SOURCE_DIR@/m4', '-I@THIS_SOURCE_DIR@/srcm4']
    tools_required:
      - host-gcc
      - host-libtool
    pkgs_required:
      - mlibc
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--with-sysroot=@SYSROOT_DIR@' # Set libtool's lt_sysroot.
        - '--disable-nls'
        - '--enable-shared'
        - '--disable-static'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: libintl
    source:
      subdir: '3rdparty'
      url: 'https://ftp.gnu.org/gnu/gettext/gettext-0.21.tar.gz'
      format: 'tar.gz'
      extract_path: 'gettext-0.21'
      version: '0.21'
      tools_required:
        - host-autoconf-v2.69
        - host-automake-v1.16
        - host-libtool
      regenerate:
        - args: |
            set -e
            sed -i 's|. $srcdir/version.sh|dnl . $srcdir/version.sh|g' libtextstyle/configure.ac
            sed -i 's|AC_INIT|. $srcdir/version.sh\nAC_INIT([libtextstyle], [$VERSION_NUMBER], [bug-gettext@gnu.org])|g' libtextstyle/configure.ac
            sed -i 's|gl_INIT_PACKAGE|dnl gl_INIT_PACKAGE|g' libtextstyle/configure.ac
        - args: ['autoreconf', '-fvi']
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
      - libiconv
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--without-emacs'
        - '--without-lispdir'
        # Normally this controls nls behavior in general, but the libintl
        # subdir is skipped unless this is explicitly set.
        - '--enable-nls'
        # This magic flag enables libintl.
        - '--with-included-gettext'
        - '--disable-c++'
        - '--disable-libasprintf'
        - '--disable-java'
        - '--enable-shared'
        - '--disable-static'
        - '--enable-threads=posix'
        - '--disable-curses'
        - '--without-git'
        - '--without-cvs'
        - '--without-bzip2'
        - '--without-xz'
    build:
      - args: ['make', '-C', 'gettext-runtime/intl', '-j@PARALLELISM@']
      - args: ['make', '-C', 'gettext-runtime/intl', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: vim
    source:
      subdir: '3rdparty'
      git: 'https://github.com/vim/vim.git'
      tag: 'v8.2.4953'
      version: '8.2.4953'
    tools_required:
      - host-pkg-config
      - host-gcc
    pkgs_required:
      - mlibc
      - ncurses
      - libiconv
    configure:
      # vim does not seem to support out-of-tree builds, so we just copy
      # the source tree into the build directory instead
      - args: ['cp', '-r', '@THIS_SOURCE_DIR@/.', '@THIS_BUILD_DIR@']
      - args:
        - './configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-gtktest'
        - '--disable-icon-cache-update'
        - '--disable-desktop-database-update'
        - '--disable-canberra'
        - '--disable-selinux'
        - '--disable-xsmp'
        - '--disable-channel'
        - '--disable-netbeans'
        - '--enable-multibyte'
        - '--disable-acl'
        - '--disable-gpm'
        - '--disable-sysmouse'
        - '--disable-nls'
        - '--with-tlib=tinfo'
        - '--enable-gui=no'
        - '--without-x'
        environ:
          ac_cv_small_wchar_t: 'no'
          ac_cv_func_sigsetjmp: 'no'
          vim_cv_toupper_broken: 'no'
          vim_cv_terminfo: 'yes'
          vim_cv_tgetent: 'zero'
          vim_cv_tty_group: ''
          vim_cv_tty_mode: '0620'
          vim_cv_getcwd_broken: 'no'
          vim_cv_stat_ignores_slash: 'no'
          vim_cv_memmove_handles_overlap: 'yes'
          vim_cv_bcopy_handles_overlap: 'yes'
          vim_cv_memcpy_handles_overlap: 'yes'
          STRIP: 'x86_64-vinix-strip'
        workdir: '@THIS_BUILD_DIR@/src/'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'

  - name: doomgeneric
    from_source: doomgeneric
    tools_required:
      - host-gcc
    pkgs_required:
      - mlibc
    build:
      - args: ['make', '-C', '@THIS_SOURCE_DIR@/doomgeneric', '-f', 'Makefile.vinix', '-j@PARALLELISM@']
      - args: ['mkdir', '-p', '@THIS_COLLECT_DIR@/usr/bin']
      - args: ['cp', '@THIS_SOURCE_DIR@/doomgeneric/doomgeneric', '@THIS_COLLECT_DIR@/usr/bin/doomgeneric']

  - name: file
    from_source: file
    tools_required:
      - host-gcc
      - host-file
    pkgs_required:
      - mlibc
      - zlib
    configure:
      - args:
        - '@THIS_SOURCE_DIR@/configure'
        - '--host=x86_64-vinix'
        - '--prefix=/usr'
        - '--disable-bzlib'
        - '--disable-xzlib'
    build:
      - args: ['make', '-j@PARALLELISM@']
      - args: ['make', 'install-strip']
        environ:
          DESTDIR: '@THIS_COLLECT_DIR@'
